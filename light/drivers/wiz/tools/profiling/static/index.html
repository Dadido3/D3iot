<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>WiZ light profiler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/api.js"></script>
</head>

<body id="color-output" style="background-color: RGB(0,0,0);">
    <div class="center-container">
        <div class="group">
            <p>Device RGBW values</p>
            <table>
                <tr><td><label>R</label></td><td><input type="number" id="input-r" class="rgbw-input" name="r" min="0" max="255"></td></tr>
                <tr><td><label>G</label></td><td><input type="number" id="input-g" class="rgbw-input" name="g" min="0" max="255"></td></tr>
                <tr><td><label>B</label></td><td><input type="number" id="input-b" class="rgbw-input" name="b" min="0" max="255"></td></tr>
                <tr><td><label>CW</label></td><td><input type="number" id="input-cw" class="rgbw-input" name="cw" min="0" max="255"></td></tr>
                <tr><td><label>WW</label></td><td><input type="number" id="input-ww" class="rgbw-input" name="ww" min="0" max="255"></td></tr>
                <tr><td>Sum</td><td id="rgbw-sum"></td></tr>
            </table>
        </div>

        <div class="group">
            <p>Reference color</p>
            <table>
                <tr><td><label>X</label></td><td><input type="number" id="input-X" class="XYZ-input" name="X" min="0" max="1" step="0.001"></td></tr>
                <tr><td><label>Y</label></td><td><input type="number" id="input-Y" class="XYZ-input" name="Y" min="0" max="1" step="0.001"></td></tr>
                <tr><td><label>Z</label></td><td><input type="number" id="input-Z" class="XYZ-input" name="Z" min="0" max="1" step="0.001"></td></tr>
                <tr><td>sRGB</td><td id="XYZ-sRGB"></td></tr>
                <tr><td>bright.</td><td><button id="button-XYZ-minus">âˆ’</button><button id="button-XYZ-plus">+</button></td></tr>
            </table>
        </div>

        <button id="button-add-data-point">add data point</button>
    </div>

    <script>
        // Convert CIE 1931 XYZ to sRGB.
        function XYZ2sRGB(input) {
            // Source: http://www.easyrgb.com/en/math.php
            // input is in the CIE 1931 XYZ color space, with each component being in the range [0, 1].
            // The result is in the sRGB color space (IEC 61966-2-1:1999), with each component being in the range [0, 255].

            // Matrix transform.
            let var_R = input.X *  3.2406 + input.Y * -1.5372 + input.Z * -0.4986;
            let var_G = input.X * -0.9689 + input.Y *  1.8758 + input.Z *  0.0415;
            let var_B = input.X *  0.0557 + input.Y * -0.2040 + input.Z *  1.0570;

            // Apply gamma curve.
            if ( var_R > 0.0031308 ) var_R = 1.055 * ( var_R ** ( 1 / 2.4 ) ) - 0.055; else var_R = 12.92 * var_R;
            if ( var_G > 0.0031308 ) var_G = 1.055 * ( var_G ** ( 1 / 2.4 ) ) - 0.055; else var_G = 12.92 * var_G;
            if ( var_B > 0.0031308 ) var_B = 1.055 * ( var_B ** ( 1 / 2.4 ) ) - 0.055; else var_B = 12.92 * var_B;

            return {R: var_R*255, G: var_G*255, B: var_B*255}
        }

        // Get device color values from user input.
        function getRGBW() {
            return {
                R: parseInt($("#input-r").val()),
                G: parseInt($("#input-g").val()),
                B: parseInt($("#input-b").val()),
                CW: parseInt($("#input-cw").val()),
                WW: parseInt($("#input-ww").val())
            };
        }

        // Get reference color from user input.
        function getXYZ() {
            return {
                X: parseFloat($("#input-X").val()),
                Y: parseFloat($("#input-Y").val()),
                Z: parseFloat($("#input-Z").val())
            };
        }

        // Change user reference color.
        function setXYZ(input) {
            $("#input-X").val(input.X.toFixed(3));
            $("#input-Y").val(input.Y.toFixed(3));
            $("#input-Z").val(input.Z.toFixed(3));
        }

        function rgbwChangeHandler(e) {
            let rgbw = getRGBW();
            api.setRGBW(rgbw);
            let sum = rgbw.R + rgbw.G + rgbw.B + rgbw.CW + rgbw.WW;
            $("#rgbw-sum").text(sum);
            if (sum >= 512) {
                $("#rgbw-sum").addClass("value-alert");
            } else {
                $("#rgbw-sum").removeClass("value-alert");
            }
        }

        function XYZUpdateColor(XYZ) {
            let sRGB = XYZ2sRGB(getXYZ());
            let {r, g, b} = {r: Math.round(sRGB.R), g: Math.round(sRGB.G), b: Math.round(sRGB.B)};
            //$("#color-output").css({"background-color": "color(sRGB " + r/255.0 + " " + g/255.0 + " " + b/255.0 + ");"}); // Not really supported anywhere.
            $("#color-output").css({"background-color": "rgb(" + r + ", " + g + ", " + b + ")"});
            $("#XYZ-sRGB").text(r + ", " + g + ", " + b);
            if (r > 255 || r < 0 || g > 255 || g < 0 || b > 255 || b < 0) {
                $("#XYZ-sRGB").addClass("value-alert");
            } else {
                $("#XYZ-sRGB").removeClass("value-alert");
            }
        }

        function XYZChangeHandler(e) {
            XYZUpdateColor(getXYZ());
        }

        function XYZMinusClickHandler(e) {
            let XYZ = getXYZ();
            XYZ.X /= 1.03;
            XYZ.Y /= 1.03;
            XYZ.Z /= 1.03;
            setXYZ(XYZ);
            XYZUpdateColor(XYZ);
        }

        function XYZPlusClickHandler(e) {
            let XYZ = getXYZ();
            XYZ.X *= 1.03;
            XYZ.Y *= 1.03;
            XYZ.Z *= 1.03;
            setXYZ(XYZ);
            XYZUpdateColor(XYZ);
        }

        function addDataPointClickHandler(e) {
            let rgbw = getRGBW();
            let XYZ = getXYZ();
            api.addDataPoint({...rgbw, ...XYZ});
        }

        $(".rgbw-input").bind('keyup change click', rgbwChangeHandler);

        $(".XYZ-input").bind('keyup change click', XYZChangeHandler);
        $("#button-XYZ-minus").bind('click', XYZMinusClickHandler);
        $("#button-XYZ-plus").bind('click', XYZPlusClickHandler);

        $("#button-add-data-point").bind('click', addDataPointClickHandler);
        
    </script>

</body>

</html>